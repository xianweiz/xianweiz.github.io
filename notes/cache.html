<!DOCTYPE html><html>

<head>
<meta charset="utf-8">
<title>cache</title>
<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>
<style type="text/css">
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #a67f59;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>
</head>
<body>
<h1 id="toc_0">Cache</h1>

<h2 id="toc_1">Table of contents</h2>

<ol>
<li><a href="#common-design">Common designs</a></li>
<li><a href="#cache-op">Cache operations</a></li>
<li><a href="#cache-write">Cache write policies</a></li>
<li><a href="#vrt-phy">Virtual or physical addr</a></li>
<li><a href="#cohe">Cache coherency</a></li>
</ol>

<h2 id="toc_2"><a name="common-design"></a> 1. Common designs <a href="#top">&uarr;top</a></h2>

<ul>
<li><strong>Fully associative</strong>: block can be anywhere in the cache</li>
<li><strong>Direct mapped</strong>: block can only be in one line in the cache</li>
<li><strong>Set-associative</strong>: block can be in a few (2 to 8) places in the cache</li>
</ul>

<h2 id="toc_3"><a name="cache-op"></a> 2. Cache operations <a href="#top">&uarr;top</a></h2>

<figure>
  <center>
  <img src="cache_img/cache.png" alt="The Pulpit Rock" width="300">
  <figcaption>Fig.1 - A cache organization.</figcaption>
  </center>
</figure>

<ul>
<li><strong>initial</strong>: all blocks are <strong>Invalid</strong> (<strong>I=0</strong>, cold start);</li>
<li><strong>read miss</strong>: target block is <strong>Invalid</strong>, or no tag match; the processor retrieves the entire 64B line to put into cache, termed as <strong>cacheline fill</strong>;</li>
<li><strong>read hit</strong>: matched tag is found, directly fetches the data from cache;</li>
<li><strong>write miss</strong>: when the processor wants to write an operand to memory, it first checks if the block is already in cache. Unfortunately, the write refers to a memory location that not currently in cache, which causes the processor to perform a cacheline-fill (<strong>write allocation</strong>) and then proceeds to modify the value of the operand in cache without writing directly to memory;</li>
<li><strong>write hit</strong>: the location is being held in cache, directly write (no eviction);</li>
<li><strong>write back</strong>: when doing allacation for read/write misses, a line needed to be evicted for the newly fetched block; if the existing cache line is dirty, do a write-back.</li>
</ul>

<p>As a summary:  </p>

<ul>
<li><strong>V=1</strong> means the line has valid data, and <strong>D=1</strong> (dirty) means the bytes are newer than main memory. </li>
<li>when allocating line, set <strong>V=1</strong>, <strong>D=0</strong> (clean) and fill in tag and data; </li>
<li>when writing a line in response to write hit, set <strong>D=1</strong>; </li>
<li>when evicting a line: if <strong>D=0</strong> (memory data is NOT stale), just set <strong>V=0</strong>; if <strong>D=1</strong> (memory data is stale), write-back the data and then set <strong>D=0</strong> and <strong>V=0</strong>.</li>
</ul>

<h2 id="toc_4"><a name="cache-write"></a> 3. Cache write policies <a href="#top">&uarr;top</a></h2>

<h3 id="toc_5">if data is already in the cache ...</h3>

<ul>
<li><strong>No-write</strong>: writes invalidate the cache and go directly to memory</li>
<li><strong>Write-through</strong>: writes go to main memory and cache</li>
<li><strong>Write-back</strong>: CPU writes only to cache; cache writes to main memory when the dirty block is later evicted.</li>
</ul>

<h3 id="toc_6">if data is not in the cache</h3>

<ul>
<li><strong>Write-allocate</strong>: allocate a cache line (put it in cache) for new data (and maybe write-through)</li>
<li><strong>No-write-allocate</strong>: write it directly to memory without allocation</li>
</ul>

<h3 id="toc_7">write-through vs. write-back</h3>

<p>A cache with a write-through policy (and write-allocate) read an entire block (cacheline) from memory on a cache miss and writes only the updated item to memory for a store. Evictions do not need to write to memory.</p>

<p>A cache with a write-back policy (and write-allocate) reads an entire block (cacheline) from memory on a cache miss, may need to write dirty cacheline first. Any writes to memory need to be the entire cacheline since no way to distinguish which word was dirty with only a single dirty bit. Evictions of a dirty cacheline cause a write to memory.</p>

<p>write-through is lower but cleaner (memory always consistent), write-back is faster but complicated when multi cores sharing memory, requiring cache coherency protocol. </p>

<h2 id="toc_8"><a name="vrt-phy"></a> 4. Virtual or physical addr <a href="#top">&uarr;top</a></h2>

<p>TLBs are small (maybe 64 entries), fully-associative caches for page table entries. </p>

<h3 id="toc_9">physical cache vs. virtual cache</h3>

<p>If we translate before we go to the cache, we have a &quot;<u>physical cache</u>&quot; which works on physical addr.<br>
<em>Critical path = TLB access time + cache access time</em></p>

<p>Alternatively, we could translate after the cache (only for cache misses), we have a &quot;<u>virtual cache</u>&quot;. Virtual cache is dangerous. We must flush the cache on a context switch to avoid &quot;aliasing&quot;. </p>

<h3 id="toc_10">virtually indexed physically tagged</h3>

<p>Page <strong>offset</strong> bits are not translated and thus can be presented to the cache immediately. Accordingly, cache and TLB accesses can begin simultaneously, and tag comparion is made after both accesses are completed.</p>

<figure>
  <center>
  <img src="cache_img/vtpi.png" alt="The Pulpit Rock" width="600">
  <figcaption>Fig.2 - Virtual index, physical tag.</figcaption>
  </center>
</figure>

<h2 id="toc_11"><a name="cohe"></a> 5. Cache coherency <a href="#top">&uarr;top</a></h2>

<p>In a shared memory multiprocessor system, an operand can have <strong>multiple copies</strong> in main memory and in caches. Cache coherence is to ensure that the changes in the values of shared operands are propagated throughout the system in a timely fashion.</p>

<p>Coherence rules:</p>

<ul>
<li>writes eventually become visible to all processors;</li>
<li>writes to the same location are serialized.</li>
</ul>

<figure>
  <center>
  <img src="cache_img/cohe.png" alt="The Pulpit Rock" width="180">
  <figcaption>Fig.3 - Cache of CMP.</figcaption>
  </center>
</figure>

<p>The most basic protocol is MSI.<br>
<strong>MSI &rarr; MESI</strong>:  </p>

<ul>
<li>MSI observation: doing read-modify-write sequences on private data is common, and hence the traffic can be reduced for writes of block on only one cache</li>
<li>MESI solution: adds <strong>E</strong> state (exclusive, clean), writes on such lines happen silently (don&#39;t tell other caches to invalidate the line), transition to <strong>M</strong> (exclusive, dirty)</li>
</ul>

<p><strong>MSI &rarr; MOSI</strong>:</p>

<ul>
<li>MSI observation: on M&rarr;S transitions, must write back line</li>
<li>MOSI solution: adds <strong>O</strong> state (owner), indicating that the current core owns this block, and will service requests from other cores for the block.</li>
</ul>

<p><strong>MSI &rarr; MOESI</strong>:</p>

<ul>
<li>achieves benefits of both MESI and MOSI</li>
</ul>

<p>MESI addes an &quot;Exclusive&quot; state to reduce the traffic caused by writes of blocks that only in one cache (a silent write in MESI). Further, MOSI adds an &quot;Owned&quot; state to reduce the traffic caused by write-backs of blocks that are read by other caches. </p>

<h3 id="toc_12">MESI protocol</h3>

<figure>
  <center>
  <img src="cache_img/MESI.png" alt="The Pulpit Rock" width="280">
  <figcaption>Fig.4 - State transitions in MESI protocol.</figcaption>
  </center>
</figure>

<p>Every cache line is marked with one of the four following states (coded in two bits):</p>

<ul>
<li><strong>M</strong>odified: the line is present only in current local cache, and is <u><em>dirty</em></u> (memory copy is stale); A write back must be performed in future, before permitting any other read of the (no longer valid) memory.<br>
The write-back changes the line to <strong>S</strong>hared state.</li>
<li><strong>E</strong>xclusive: the line is present only in current local cache, but is <u><em>clean</em></u> (matches main memory); it may be changed to <strong>S</strong>hared at any time, in response to a read request. It may also be changed to <strong>M</strong>odified state when writing to it.</li>
<li><strong>S</strong>hared: the line may be also stored in other caches and is <u><em>clean</em></u> (matches main memory). The line may be discarded (changed to <strong>I</strong>nvalid state) at any time.</li>
<li><strong>I</strong>nvalid: the cache line is invalid (unused).</li>
</ul>

<p>Transitions (assume <u>local</u> is on <u>core0</u> and <u>remote</u> is on <u>core1</u>):</p>

<ul>
<li><strong>I</strong> &rarr;: <strong>E</strong> (core0_R) / <strong>M</strong> (core0_W);</li>
<li><strong>E</strong> &rarr;: <strong>M</strong> (core0_W) / <strong>S</strong> (core1_R) / <strong>I</strong> (core1_W);</li>
<li><strong>M</strong> &rarr;: <strong>S</strong> (core1_R) / <strong>I</strong> (core1_W);</li>
<li><strong>S</strong> &rarr;: <strong>M</strong> (core0_W) / <strong>I</strong> (core1_W).</li>
</ul>

<p>A cache may satisfy a read from any state except <strong>Invalid</strong>. An invalid line must be fetched (to the <strong>Shared</strong> or <strong>Exclusive</strong> states) to satisfy a read.</p>

<p>A write may only be performed if the cache line is in the <strong>Modified</strong> or <strong>Exclusive</strong> state. If it is in <strong>Shared</strong> state, all other cached copies must be invalidated first. This is typically done by a broadcast operation known as RfO.</p>

<p>A cache may discard a non-Modified line (i.e., <strong>Shared</strong> or <strong>Exclusive</strong>) at any time, changing to the <strong>Invalid</strong> state. A <strong>Modified</strong> line must be written back first.</p>

<p>A cache that holds a line in the <strong>Modified</strong> state must snoop (intercept) all attempted reads (from all of the other caches in the system) of the corresponding main mem location and insert the data it holds. This is typically done by forcing the read to back off (i.e., retry later), then writing the data to main memory and changing the cache line to <strong>Shared</strong> state.</p>

<p>A cache that holds a line in the <strong>Shared</strong> state must listen for invalidate or RfO broadcasts from other caches, and discard the line (by moving it into <strong>Invalid</strong>) on a match.</p>

<p>A cache that holds a line in <strong>Exclusive</strong> state must also snoop all read transactions from all other caches, and move the line into <strong>Shared</strong> state on a match.</p>

<h3 id="toc_13">Snooping cache</h3>

<p>Snooping is widely used in <strong>bus-based multiprocessors</strong>. The cache controller constantly watches the bus.</p>

<ul>
<li><strong>Write invalidate</strong>: when a processor writes to local cache <em>C</em>, all copies of it in other processors are invalidated. These processors have to read or valid copy either from memory (<em>M</em>), or from the processor that modified the variable.</li>
<li><strong>Write broadcast</strong>: instead of invalidating, the processor can broadcast the updated value to other processors sharing the copy. This acts as write through for shared data, and write back for private data.</li>
</ul>

<p>[1] <a href="http://www.cs.cornell.edu/courses/cs3410/2013sp/lecture/18-caches3-w.pdf">Cache general structure</a><br>
[2] <a href="https://inst.eecs.berkeley.edu/%7Ecs152/sp10/lectures/L11-VMCaches.pdf">Virtual cache</a><br>
[3] <a href="https://homepages.wmich.edu/%7Ebazuinb/ECE6050/CacheCoherence.pdf">Cache coherence</a><br>
[4] <a href="http://sc.tamu.edu/systems/eos/hardware.php">MESI protocol</a><br>
[5] <a href="http://users.cms.caltech.edu/%7Edonnie/cs24/CS24Lec16.pdf">MSI and variants</a><br>
[6] <a href="http://courses.csail.mit.edu/6.888/spring13/lectures/L7-coherence.pdf">Cache coherence (MIT)</a></p>

<script type="text/javascript">
var _self="undefined"!=typeof window?window:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?self:{},Prism=function(){var e=/\blang(?:uage)?-(?!\*)(\w+)\b/i,t=_self.Prism={util:{encode:function(e){return e instanceof n?new n(e.type,t.util.encode(e.content),e.alias):"Array"===t.util.type(e)?e.map(t.util.encode):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\u00a0/g," ")},type:function(e){return Object.prototype.toString.call(e).match(/\[object (\w+)\]/)[1]},clone:function(e){var n=t.util.type(e);switch(n){case"Object":var a={};for(var r in e)e.hasOwnProperty(r)&&(a[r]=t.util.clone(e[r]));return a;case"Array":return e.map&&e.map(function(e){return t.util.clone(e)})}return e}},languages:{extend:function(e,n){var a=t.util.clone(t.languages[e]);for(var r in n)a[r]=n[r];return a},insertBefore:function(e,n,a,r){r=r||t.languages;var l=r[e];if(2==arguments.length){a=arguments[1];for(var i in a)a.hasOwnProperty(i)&&(l[i]=a[i]);return l}var o={};for(var s in l)if(l.hasOwnProperty(s)){if(s==n)for(var i in a)a.hasOwnProperty(i)&&(o[i]=a[i]);o[s]=l[s]}return t.languages.DFS(t.languages,function(t,n){n===r[e]&&t!=e&&(this[t]=o)}),r[e]=o},DFS:function(e,n,a){for(var r in e)e.hasOwnProperty(r)&&(n.call(e,r,e[r],a||r),"Object"===t.util.type(e[r])?t.languages.DFS(e[r],n):"Array"===t.util.type(e[r])&&t.languages.DFS(e[r],n,r))}},plugins:{},highlightAll:function(e,n){for(var a,r=document.querySelectorAll('code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'),l=0;a=r[l++];)t.highlightElement(a,e===!0,n)},highlightElement:function(n,a,r){for(var l,i,o=n;o&&!e.test(o.className);)o=o.parentNode;o&&(l=(o.className.match(e)||[,""])[1],i=t.languages[l]),n.className=n.className.replace(e,"").replace(/\s+/g," ")+" language-"+l,o=n.parentNode,/pre/i.test(o.nodeName)&&(o.className=o.className.replace(e,"").replace(/\s+/g," ")+" language-"+l);var s=n.textContent,u={element:n,language:l,grammar:i,code:s};if(!s||!i)return t.hooks.run("complete",u),void 0;if(t.hooks.run("before-highlight",u),a&&_self.Worker){var g=new Worker(t.filename);g.onmessage=function(e){u.highlightedCode=e.data,t.hooks.run("before-insert",u),u.element.innerHTML=u.highlightedCode,r&&r.call(u.element),t.hooks.run("after-highlight",u),t.hooks.run("complete",u)},g.postMessage(JSON.stringify({language:u.language,code:u.code,immediateClose:!0}))}else u.highlightedCode=t.highlight(u.code,u.grammar,u.language),t.hooks.run("before-insert",u),u.element.innerHTML=u.highlightedCode,r&&r.call(n),t.hooks.run("after-highlight",u),t.hooks.run("complete",u)},highlight:function(e,a,r){var l=t.tokenize(e,a);return n.stringify(t.util.encode(l),r)},tokenize:function(e,n){var a=t.Token,r=[e],l=n.rest;if(l){for(var i in l)n[i]=l[i];delete n.rest}e:for(var i in n)if(n.hasOwnProperty(i)&&n[i]){var o=n[i];o="Array"===t.util.type(o)?o:[o];for(var s=0;s<o.length;++s){var u=o[s],g=u.inside,c=!!u.lookbehind,f=0,h=u.alias;u=u.pattern||u;for(var p=0;p<r.length;p++){var d=r[p];if(r.length>e.length)break e;if(!(d instanceof a)){u.lastIndex=0;var m=u.exec(d);if(m){c&&(f=m[1].length);var y=m.index-1+f,m=m[0].slice(f),v=m.length,k=y+v,b=d.slice(0,y+1),w=d.slice(k+1),P=[p,1];b&&P.push(b);var A=new a(i,g?t.tokenize(m,g):m,h);P.push(A),w&&P.push(w),Array.prototype.splice.apply(r,P)}}}}}return r},hooks:{all:{},add:function(e,n){var a=t.hooks.all;a[e]=a[e]||[],a[e].push(n)},run:function(e,n){var a=t.hooks.all[e];if(a&&a.length)for(var r,l=0;r=a[l++];)r(n)}}},n=t.Token=function(e,t,n){this.type=e,this.content=t,this.alias=n};if(n.stringify=function(e,a,r){if("string"==typeof e)return e;if("Array"===t.util.type(e))return e.map(function(t){return n.stringify(t,a,e)}).join("");var l={type:e.type,content:n.stringify(e.content,a,r),tag:"span",classes:["token",e.type],attributes:{},language:a,parent:r};if("comment"==l.type&&(l.attributes.spellcheck="true"),e.alias){var i="Array"===t.util.type(e.alias)?e.alias:[e.alias];Array.prototype.push.apply(l.classes,i)}t.hooks.run("wrap",l);var o="";for(var s in l.attributes)o+=(o?" ":"")+s+'="'+(l.attributes[s]||"")+'"';return"<"+l.tag+' class="'+l.classes.join(" ")+'" '+o+">"+l.content+"</"+l.tag+">"},!_self.document)return _self.addEventListener?(_self.addEventListener("message",function(e){var n=JSON.parse(e.data),a=n.language,r=n.code,l=n.immediateClose;_self.postMessage(t.highlight(r,t.languages[a],a)),l&&_self.close()},!1),_self.Prism):_self.Prism;var a=document.getElementsByTagName("script");return a=a[a.length-1],a&&(t.filename=a.src,document.addEventListener&&!a.hasAttribute("data-manual")&&document.addEventListener("DOMContentLoaded",t.highlightAll)),_self.Prism}();"undefined"!=typeof module&&module.exports&&(module.exports=Prism),"undefined"!=typeof global&&(global.Prism=Prism);
</script>
</body>

</html>
